
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>mylifeecho - Fluent Builder in C#</title>
    <meta name="description" content="I like the pattern “Fluent builder”. This pattern provides an easy and transparent way to build complex objects with an hierarchical structure. If you are the developer of a builder, this pattern helps you to hide complexity of building objects, manage the subnode creation, define the order in which client should call methods of builder, where the order is important, and gives you other advantages of using “Builder” pattern, described in the book written by GoF.">
    <meta name="author" content="Alexey Rodiontsev">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="/assets/themes/lifeecho/stylesheets/base.css">
    <link rel="stylesheet" href="/assets/themes/lifeecho/stylesheets/skeleton.css">
    <link rel="stylesheet" href="/assets/themes/lifeecho/stylesheets/layout.css">
    <link rel="stylesheet" href="/assets/themes/lifeecho/stylesheets/theme.css">
    <link rel="stylesheet" href="/assets/themes/lifeecho/stylesheets/github.css">

    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Favicons
    ================================================== -->
    <link rel="shortcut icon" href="/assets/themes/lifeecho/images/favicon.ico">
    <link rel="apple-touch-icon" href="/assets/themes/lifeecho/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/themes/lifeecho/images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/themes/lifeecho/images/apple-touch-icon-114x114.png">
  </head>

  <body>
      <div id="header" class="sixteen columns">
          <div id="header-container" class="container">
              <div id="branding" class="five columns">
                  <h1><a href="/">mylifeecho</a></h1>
                  <h5>Alexey Rodiontsev's personal blog</h5>
              </div>
              <div id="layout-navigation">
                  <nav>
                    <ul class="menu menu-main-menu">
                      <li class="first"><a href="/">Blog</a></li>
                      <li><a href="/notes-tips-tricks">Notes, Tips and Tricks</a></li>
                      <li class="last"><a href="/about">About</a></li>
                    </ul>
                  </nav>
              </div>
          </div>
      </div>
      <div id="main" class="container">
        <div class="content eleven columns">
          
<article class="content-item blog-post">
  <header>
    <h1>Fluent Builder in C# </h1>
    
    <div class="tags">Tags:
      <ul class="tag_box inline">
        
        


  
     
    	<li><a href="#C#-ref">C# <span>1</span></a></li>
     
    	<li><a href="#Design Pattern-ref">Design Pattern <span>1</span></a></li>
    
  



      </ul>
    </div>
    
    <div class="metadata">
      <div class="published">27 May 2013</div>
    </div>
  </header>

  <p>I like the pattern “Fluent builder”. This pattern provides an easy and transparent way to build complex objects with an hierarchical structure. If you are the developer of a builder, this pattern helps you to hide complexity of building objects, manage the subnode creation, define the order in which client should call methods of builder, where the order is important, and gives you other advantages of using “Builder” pattern, described in the book written by <a href="/books/#design-patterns">GoF</a>. </p>

<p>If you are the developer, who use a fluent builder at the first time, you have a better protection from the use of class in wrong way and your code will be more transparently. Also you have an easy way to investigate the interface of the builder on-the-fly (it is more convinient if you have something like IntelliSence).</p>

<p>Look at this </p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">var</span> <span class="n">doc</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SomeDocument</span><span class="p">();</span>
<span class="n">doc</span><span class="p">.</span><span class="nf">Initialize</span><span class="p">(</span><span class="n">param1</span><span class="p">,</span> <span class="n">param2</span><span class="p">);</span>

<span class="n">var</span> <span class="n">subnode1</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Subnode</span><span class="p">();</span>
<span class="n">subnode1</span><span class="p">.</span><span class="nf">SetType</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
<span class="n">subnode1</span><span class="p">.</span><span class="nf">SetName</span><span class="p">(</span><span class="n">name1</span><span class="p">);</span>
<span class="n">subnode1</span><span class="p">.</span><span class="nf">Bind</span><span class="p">(</span><span class="n">doc</span><span class="p">);</span>

<span class="n">doc</span><span class="p">.</span><span class="nf">AddNode</span><span class="p">(</span><span class="n">subnode1</span><span class="p">);</span>

<span class="n">var</span> <span class="n">subnode2</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Subnode</span><span class="p">();</span>
<span class="n">subnode2</span><span class="p">.</span><span class="nf">SetName</span><span class="p">(</span><span class="n">name2</span><span class="p">);</span>
<span class="n">subnode1</span><span class="p">.</span><span class="nf">Bind</span><span class="p">(</span><span class="n">doc</span><span class="p">);</span>

<span class="n">doc</span><span class="p">.</span><span class="nf">AddNode</span><span class="p">(</span><span class="n">subnode2</span><span class="p">);</span>
<span class="n">doc</span><span class="p">.</span><span class="nf">Save</span><span class="p">();</span>
</code></pre></div>
<p>And compare it with this:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">DocBuilder</span><span class="p">.</span><span class="nf">CreateDocument</span><span class="p">(</span><span class="n">param1</span><span class="p">,</span> <span class="n">param2</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">AddNode</span><span class="p">(</span><span class="n">node</span> <span class="p">=&gt;</span> <span class="n">node</span>
        <span class="p">.</span><span class="nf">SetType</span><span class="p">(</span><span class="n">type</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">SetName</span><span class="p">(</span><span class="n">name1</span><span class="p">))</span>
    <span class="p">.</span><span class="nf">AddNode</span><span class="p">(</span><span class="n">node</span> <span class="p">=&gt;</span> <span class="n">node</span>
        <span class="p">.</span><span class="nf">SetName</span><span class="p">(</span><span class="n">name2</span><span class="p">))</span>
    <span class="p">.</span><span class="nf">Save</span><span class="p">();</span>
</code></pre></div>
<p>In the first case you may forget about the “Initialization” or “Bind” methods, forget to add a new node or add it correctly (we will see this case below in live example with <a href="http://sourceforge.net/projects/itextsharp/">iTextSharp</a>), you have to define a lot of local variables and when you call method <code>Save()</code> you may try to add a new node and hope that it will be applied.</p>

<p>Now I’m going to describe how to implement fluent builder in C# to wrap a simple process of generation PDF document by using iTextSharp and get the code similar to that one presented above. Of course it may be more complex in your case and lead to a long invocation chain but this pattern should be used wisely as everything else.</p>

<p>First of all we should define what we are going to do. We will create PDF document with 2 pages which should have a image and empty background and small text messages. Thereby we have to create document and page builder classes and two interfaces of page builder to define the order of page building process. We will prohibit instantiation of page builder by client code with help of internal keyword before constructor to have more control over creation process and hide the complexity of this process.</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">PDFBuilder</span> <span class="p">:</span> <span class="n">IDisposable</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">Document</span> <span class="n">_document</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">PDFBuilder</span><span class="p">(</span><span class="n">Stream</span> <span class="n">stream</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_document</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Document</span><span class="p">();</span>
        <span class="n">PdfWriter</span><span class="p">.</span><span class="nf">GetInstance</span><span class="p">(</span><span class="n">_document</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
        <span class="n">_document</span><span class="p">.</span><span class="nf">SetPageSize</span><span class="p">(</span><span class="n">PageSize</span><span class="p">.</span><span class="n">A5</span><span class="p">);</span>
        <span class="n">_document</span><span class="p">.</span><span class="nf">Open</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">PDFBuilder</span> <span class="nf">AddPage</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">IFirstStep</span><span class="p">&gt;</span> <span class="n">buildPage</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// code to add page
</span>    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Save</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">_document</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// IDisposable interface implementation
</span><span class="p">}</span>

<span class="k">public</span> <span class="k">interface</span> <span class="n">IFirstStep</span>
<span class="p">{</span>
    <span class="n">ISecondStep</span> <span class="nf">BackgroundImage</span><span class="p">(</span><span class="kt">string</span> <span class="n">imagePath</span><span class="p">);</span>
    <span class="n">ISecondStep</span> <span class="nf">LeaveEmptyBackground</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">interface</span> <span class="n">ISecondStep</span>
<span class="p">{</span>
    <span class="n">ISecondStep</span> <span class="nf">AddParagraph</span><span class="p">(</span><span class="kt">string</span> <span class="n">text</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Creation of page with using <a href="http://sourceforge.net/projects/itextsharp/">iTextSharp</a> is good example of the necessity to keep in mind order of calling methods to create page correctly. First of all we should set page size, then call NewPage method, set margins for all document to apply it for building page, and for a new page we should repeat all this actions. During creation of a page we don’t have any object of page, and this process is more procedural than object-oriented, but we hide it in our builder. </p>

<p>You can see implementation of AddPage method below.</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">PDFBuilder</span> <span class="p">:</span> <span class="n">IDisposable</span>
<span class="p">{</span>
    <span class="c1">// ...
</span>
    <span class="k">public</span> <span class="n">PDFBuilder</span> <span class="nf">AddPage</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">IFirstStep</span><span class="p">&gt;</span> <span class="n">buildPage</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">_document</span><span class="p">.</span><span class="nf">NewPage</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="s">"Unable to create page."</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">_document</span><span class="p">.</span><span class="nf">SetMargins</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>

        <span class="nf">buildPage</span><span class="p">(</span><span class="k">new</span> <span class="nf">PageBuilder</span><span class="p">(</span><span class="n">_document</span><span class="p">));</span>

        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// ...
</span><span class="p">}</span>
</code></pre></div>
<p>The most important thing here is that argument of <code>AddPage</code> method is an action where we define how to build our page. Client code passes all information about the creation of page to the method of PDF builder which will be executed in due time. Notice that we pass buildPage action to the PageBuilder instance, but the type defined in <code>AddPage</code> action is <code>IFirstStep</code>. This interface defines two opposit actions, so after one of them we returns <code>ISecondStep</code> interface and client code can only add paragraphs to our PDF file. Listing below shows implementation of PageBuilder class.</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">PageBuilder</span> <span class="p">:</span> <span class="n">IFirstStep</span><span class="p">,</span> <span class="n">ISecondStep</span>
<span class="p">{</span>
    <span class="c1">// ...
</span>    <span class="k">public</span> <span class="n">ISecondStep</span> <span class="nf">BackgroundImage</span><span class="p">(</span><span class="kt">string</span> <span class="n">imagePath</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">var</span> <span class="n">image</span> <span class="p">=</span> <span class="n">Image</span><span class="p">.</span><span class="nf">GetInstance</span><span class="p">(</span><span class="n">imagePath</span><span class="p">);</span>

        <span class="n">Rectangle</span> <span class="n">pageSize</span> <span class="p">=</span> <span class="n">_document</span><span class="p">.</span><span class="n">PageSize</span><span class="p">;</span>
        <span class="n">image</span><span class="p">.</span><span class="nf">ScaleToFit</span><span class="p">(</span><span class="n">pageSize</span><span class="p">.</span><span class="n">Width</span><span class="p">,</span> <span class="n">pageSize</span><span class="p">.</span><span class="n">Height</span><span class="p">);</span>

        <span class="n">image</span><span class="p">.</span><span class="nf">SetAbsolutePosition</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">pageSize</span><span class="p">.</span><span class="n">Height</span> <span class="p">-</span> <span class="n">image</span><span class="p">.</span><span class="n">ScaledHeight</span><span class="p">);</span>
        <span class="n">_document</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">image</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">ISecondStep</span> <span class="nf">LeaveEmptyBackground</span><span class="p">()</span> 
    <span class="p">{</span> 
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span> 
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">ISecondStep</span> <span class="nf">AddParagraph</span><span class="p">(</span><span class="kt">string</span> <span class="n">text</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_document</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Paragraph</span><span class="p">(</span><span class="n">text</span><span class="p">));</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>And how it looks for developer who uses this builder.</p>

<p><img src="/assets/posts/2013-05-27/flient-builder-use.png" alt="example"></p>


  


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'mylifeecho'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>





</article>

        </div>
        <div class="sidebar five columns">
          <article class="widget">
    <header>
        <h3>About me</h3>
    </header>
    <p>My name is Alexey Rodiontsev. I&rsquo;m a software engineer at Irdeto B.V., Amsterdam, The Netherlands.</p>
</article>
<article class="widget">
    <header>
        <h3>Connect</h3> 
    </header>
    <p>
      <a href="https://twitter.com/klappvisor" title="twitter">
        <img src="/assets/sidebar/c-icon-twi.png" alt="" width="64" height="64" />
      </a>
      <a href="https://github.com/klappvisor" title="GitHub">
        <img src="/assets/sidebar/c-icon-git.png" alt="" width="64" height="64" />
      </a>
      <a href="http://www.linkedin.com/in/alexeyrodiontsev" title="Linked In">
        <img src="/assets/sidebar/c-icon-in.png" alt="" width="64" height="64" />
      </a>
      <a href="http://feeds.feedburner.com/mylifeecho" title="RSS">
        <img src="/assets/sidebar/c-icon-rss.png" alt="" width="64" height="64" />
      </a>
      <a href="http://stackoverflow.com/users/793874/" title="stackoverflow">
        <img src="/assets/sidebar/icon-stacko.png" alt="" width="64" height="64" />
      </a>
      <a href="https://github.com/mylifeecho" title="examples">
        <img src="/assets/sidebar/c-icon-git.png" alt="" style="margin-left: 5px; margin-bottom: 3px;" width="32" height="32" />
      </a>
    </p>
</article>
<article class="widget">
    <header>
        <h3>Recommended Reading</h3>
    </header>
    <ul style="padding-left: 0;">
      <li><a href="/books#code-complete">Code Complete</a></li>
      <li><a href="/books#design-patterns">Design patterns : elements of reusable object-oriented software</a></li>
      <li><a href="/books#csharp-in-a-nutshell">C# in a Nutshell</a></li>
      <li><a href="/books#31days-of-refactoring">31 days of refactoring</a></li>
    </ul>
    <p></p>
</article>
<article class="widget">
    <header>
        <h3>Others</h3>
    </header>
    <p>
      <a href="/certifications">
        <img src="/assets/sidebar/MCSD(rgb)_1477.png" alt="MCSD: Web Applications" style="float: initial;" width="217" height="63" />
      </a>
    </p>
    <p></p>
</article>
        </div>
      </div>
      
      <div id="footer-wrapper">
          <footer class="container">
              <p>&copy; 2015 Alexey Rodiontsev
                with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
              </p>
          </footer>
      </div>

    
  </body>
</html>
